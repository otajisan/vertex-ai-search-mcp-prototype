---
description: 運用・データパイプライン用スクリプト (Python) の開発ルール
globs: scripts/**/*.py, scripts/**/pyproject.toml
---

# 運用スクリプト開発ルール (Python)

このファイルは `scripts/` ディレクトリ配下の開発ルールを定義します。
主な役割は、非構造化データの ETL（抽出・変換・ロード）と Vertex AI Search へのインデックス登録です。

## 1. 開発環境と依存管理

- **パッケージマネージャー**: `uv` を使用してください。
    - `uv venv` で仮想環境を作成。
    - `uv pip install ...` でライブラリを追加。
- **Pythonバージョン**: 3.12以上を使用してください。

## 2. 実装ガイドライン

### 型安全性と品質
- **Type Hinting**: すべての関数引数と戻り値に型ヒントを記述してください。
- **Pydantic**: 複雑なデータ構造（メタデータやAPIレスポンス）を扱う際は、辞書 (`dict`) をそのまま回さず、Pydantic モデルを定義して検証してください。
- **Docstrings**: Google Style の Docstring を記述してください。

### Vertex AI Search との整合性
Kotlin製のサーバーアプリケーション (`mcp/`) が正しく検索できるように、以下のデータスキーマ規約を厳守してください。

- **日付フィールド**: 
    - フィールド名は `date` とする（`structData.date` ではない）。
    - フォーマットは `YYYY-MM-DD` (ISO 8601) とする。
- **ファイル名**: `title` フィールドに格納する。
- **URI**: GCSのパス (`gs://...`) を `link` または `uri` フィールドとして正確に保持する。

### エラーハンドリングとログ
- 長時間のバッチ処理になることが多いため、`print` ではなく `logging` モジュールを使用し、タイムスタンプを含めて出力してください。
- 1つのファイルの失敗で全体を止めず、エラーをログに出力して次のファイルの処理へ進む（Fail-Safe）設計にしてください。

## 3. ディレクトリ構造

`scripts/`
├── `etl/`           (抽出・加工ロジック)
│   ├── `extractors/` (PDF, Docx 等のパーサー)
│   └── `metadata/`   (ファイル名から日付等を推測するロジック)
├── `tools/`         (Vertex AI 管理用)
│   ├── `import_gcs.py` (GCSからデータストアへのインポート)
│   └── `verify_search.py` (検索精度の検証用スクリプト)
└── `pyproject.toml` (依存関係定義)
